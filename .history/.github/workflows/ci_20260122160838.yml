name: CI Pipeline

on:
  push:
    branches: [ main, master, develop, kriss, desarrollo-ronal, carlos ]
  pull_request:
    branches: [ main, master, develop ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  test:
    name: Test Django Application
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: seguros_personas
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: tailwind/package-lock.json

      - name: Install Tailwind CSS dependencies
        working-directory: ./tailwind
        run: npm ci

      - name: Compile Tailwind CSS
        working-directory: ./tailwind
        run: |
          npx tailwindcss -i ./input.css -o ../static/css/output.css --minify

      - name: Install MySQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y default-mysql-client

      - name: Wait for MySQL to be ready
        run: |
          for i in {1..30}; do
            if mysql -h 127.0.0.1 -P 3306 -u root -proot -e "SELECT 1" &>/dev/null 2>&1; then
              echo "MySQL is ready!"
              break
            fi
            echo "Waiting for MySQL... ($i/30)"
            sleep 2
          done

      - name: Create test settings file
        run: |
          cat > config/test_settings.py << 'EOF'
          from .settings import *
          
          # Override database settings for CI
          DATABASES = {
              'default': {
                  'ENGINE': 'django.db.backends.mysql',
                  'NAME': 'seguros_personas',
                  'USER': 'root',
                  'PASSWORD': 'root',
                  'HOST': '127.0.0.1',
                  'PORT': '3306',
                  'OPTIONS': {
                      'charset': 'utf8mb4',
                  },
              }
          }
          
          # CI-specific settings
          SECRET_KEY = 'django-insecure-test-key-for-ci-only'
          DEBUG = False
          ALLOWED_HOSTS = ['*']
          EOF

      - name: Run Django migrations
        env:
          DJANGO_SETTINGS_MODULE: config.test_settings
        run: |
          python manage.py migrate --noinput

      - name: Check for missing migrations
        env:
          DJANGO_SETTINGS_MODULE: config.test_settings
        run: |
          python manage.py makemigrations --check --dry-run || echo "Note: Some apps may have pending migrations"

      - name: Run Django tests
        env:
          DJANGO_SETTINGS_MODULE: config.test_settings
        run: |
          python manage.py test --verbosity=2

      - name: Django check
        env:
          DJANGO_SETTINGS_MODULE: config.test_settings
        run: |
          python manage.py check || echo "Django check completed with warnings"

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort

      - name: Check code formatting with Black
        continue-on-error: true
        run: |
          black --check --diff .

      - name: Check import sorting with isort
        continue-on-error: true
        run: |
          isort --check-only --diff .

      - name: Lint with flake8
        continue-on-error: true
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  build:
    name: Build and Verify
    runs-on: ubuntu-latest
    needs: [test, lint]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: tailwind/package-lock.json

      - name: Install Tailwind CSS dependencies
        working-directory: ./tailwind
        run: npm ci

      - name: Build Tailwind CSS for production
        working-directory: ./tailwind
        run: |
          npx tailwindcss -i ./input.css -o ../static/css/output.css --minify

      - name: Create build settings file
        run: |
          cat > config/build_settings.py << 'EOF'
          from .settings import *
          
          SECRET_KEY = 'django-insecure-build-key'
          DEBUG = False
          ALLOWED_HOSTS = ['*']
          EOF

      - name: Collect static files
        env:
          DJANGO_SETTINGS_MODULE: config.build_settings
        run: |
          python manage.py collectstatic --noinput --clear || echo "Static files collection skipped (no STATIC_ROOT configured)"

      - name: Verify build
        run: |
          echo "Build completed successfully!"
          ls -la static/css/ || echo "Static CSS directory check"
