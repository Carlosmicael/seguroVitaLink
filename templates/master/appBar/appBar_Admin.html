{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppBar Reutilizable</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    
    <!-- AppBar Fixed -->
    <nav class="bg-gradient-to-r from-teal-900 via-teal-800 to-teal-900 shadow-lg fixed top-0 left-0 right-0 z-50">
        <div class="max-w-full mx-auto px-6 py-3">
            <div class="flex items-center justify-between gap-8">
                
                <!-- Logo -->
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div class="flex gap-1">
                            <div class="w-2 h-6 bg-emerald-400 rounded-sm transform -skew-x-12"></div>
                            <div class="w-2 h-6 bg-emerald-500 rounded-sm transform -skew-x-12"></div>
                        </div>
                        <h3 class="text-xl font-bold tracking-wide text-white">VitaLink Admin</h3>
                    </div>
                </div>

                <!-- Search -->
                <div class="flex-1 max-w-lg">
                    <div class="relative">
                        <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-teal-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input 
                            type="text" 
                            placeholder="search..." 
                            class="w-full pl-12 pr-4 py-2.5 bg-teal-800/50 border border-teal-700 rounded-xl text-white placeholder-teal-300 focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:bg-teal-800/70 transition-all"
                        >
                    </div>
                </div>

                <!-- Navigation Links -->
                <div class="hidden lg:flex items-center gap-8">
                    <a href="#" class="text-teal-200 hover:text-emerald-400 font-medium text-sm transition-colors">Dashboard</a>
                    <a href="#" class="text-teal-200 hover:text-emerald-400 font-medium text-sm transition-colors">Analytics</a>
                    <a href="#" class="text-teal-200 hover:text-emerald-400 font-medium text-sm transition-colors">Sales</a>
                    <a href="#" class="text-teal-200 hover:text-emerald-400 font-medium text-sm transition-colors">Products</a>
                </div>

                <!-- Right Section -->
                <div class="flex items-center gap-4">
                    <!-- Settings Icon -->
                    <button class="w-10 h-10 bg-teal-800/50 hover:bg-teal-700/50 border border-teal-700 rounded-lg flex items-center justify-center transition-all hover:shadow-md" onclick="openNotifications()">
                        <svg class="w-5 h-5 text-teal-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
                        </svg>
                    </button>






















                    <!-- Notifications Icon -->
                    <div class="relative">

                        <button id="notificationBtn" class="w-10 h-10 bg-teal-800/50 hover:bg-teal-700/50 border border-teal-700 rounded-lg flex items-center justify-center transition-all hover:shadow-md">
                            <svg class="w-5 h-5 text-teal-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                            </svg>
                            <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-semibold rounded-full flex items-center justify-center border-2 border-teal-900 notification-badge"></span>
                        </button >












                        <!-- Notifications Modal -->
                        <div id="notificationsModal" class="hidden absolute top-14 right-0 w-96 bg-white rounded-2xl shadow-2xl overflow-hidden z-50">
                            <!-- Header -->
                            <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900">Notificaciones</h3>
                                <button class="text-sm text-teal-600 hover:underline font-medium">Marcar como leídas</button>
                            </div>







                            <!-- Notifications List -->
                            <div class="max-h-96 overflow-y-auto notification-content" id="notification-content">





                                <!-- Notification 1 (Unread) -->
                                <div class="px-6 py-4 hover:bg-gray-50 cursor-pointer border-b border-gray-100 bg-teal-50 transition-colors">
                                    <div class="flex gap-4">
                                        <div class="w-10 h-10 bg-gradient-to-br from-teal-600 to-teal-800 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="12" cy="7" r="4"></circle>
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-900 text-sm mb-1">Nuevo usuario registrado</div>
                                            <div class="text-gray-600 text-sm">María González se ha registrado en la plataforma</div>
                                            <div class="text-gray-400 text-xs mt-2">Hace 5 minutos</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Notification 2 (Unread) -->
                                <div class="px-6 py-4 hover:bg-gray-50 cursor-pointer border-b border-gray-100 bg-teal-50 transition-colors">
                                    <div class="flex gap-4">
                                        <div class="w-10 h-10 bg-gradient-to-br from-teal-600 to-teal-800 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-900 text-sm mb-1">Tarea completada</div>
                                            <div class="text-gray-600 text-sm">El reporte mensual ha sido generado exitosamente</div>
                                            <div class="text-gray-400 text-xs mt-2">Hace 1 hora</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Notification 3 (Unread) -->
                                <div class="px-6 py-4 hover:bg-gray-50 cursor-pointer border-b border-gray-100 bg-teal-50 transition-colors">
                                    <div class="flex gap-4">
                                        <div class="w-10 h-10 bg-gradient-to-br from-teal-600 to-teal-800 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-900 text-sm mb-1">Actualización disponible</div>
                                            <div class="text-gray-600 text-sm">Nueva versión 2.5.0 disponible para instalar</div>
                                            <div class="text-gray-400 text-xs mt-2">Hace 3 horas</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Notification 4 (Read) -->
                                <div class="px-6 py-4 hover:bg-gray-50 cursor-pointer border-b border-gray-100 transition-colors">
                                    <div class="flex gap-4">
                                        <div class="w-10 h-10 bg-gradient-to-br from-teal-600 to-teal-800 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                                <line x1="3" y1="10" x2="21" y2="10"></line>
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-900 text-sm mb-1">Recordatorio de reunión</div>
                                            <div class="text-gray-600 text-sm">Reunión de equipo mañana a las 10:00 AM</div>
                                            <div class="text-gray-400 text-xs mt-2">Ayer</div>
                                        </div>
                                    </div>
                                </div>




                            </div>
                        </div>



                    </div>









                    





                </div>
            </div>
        </div>
    </nav>

    <audio id="notification-sound" src="{% static 'sounds/notification-sound-effect-372475.mp3' %}"></audio>
    
    </div>


</body>
</html>





<div class="sidebar-overlay" id="sidebarOverlay"></div>
<script src="https://js.pusher.com/7.2/pusher.min.js"></script>

<script>



  const notificationBtn = document.getElementById('notificationBtn');
  const notificationsModal = document.getElementById('notificationsModal');

  notificationBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    notificationsModal.classList.toggle('hidden');
    openNotifications();
  });

  document.addEventListener('click', (e) => {
    if (!notificationsModal.contains(e.target) && !notificationBtn.contains(e.target)) {
      notificationsModal.classList.add('hidden');
    }
  });

  notificationsModal.addEventListener('click', (e) => {
    e.stopPropagation();
  });





    



    

    //notificaciones y el resto//
    const userId = {{ user.id }};
    const pusher = new Pusher('3e0fb7f926cfffecfe16', {cluster: 'us2', encrypted: true, authEndpoint: '/pusher/auth/'});
    const channel = pusher.subscribe(`private-user-${userId}`);







    let cantidad = 0;
    nameNotificationBadge = document.querySelector(".notification-badge")
    nameNotificationBadge.style.display = "none"



    
    let mensajes = [];
    //permisos para al snotificacioens//
    let audioEnabled = false; 
    document.addEventListener('DOMContentLoaded', () => {
      if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
        Notification.requestPermission().then(permission => {
          console.log("Permiso:", permission);
        });
      } else {
        console.log("Ya se solicitó el permiso o no es compatible.");
      }
    });








    //escuchamos el evento de pusher para mostrar nuevas notificaciones//
    channel.bind('my-event', function(data) {
      const sound = document.getElementById('notification-sound');
      setTimeout(() => {
        cantidad++;
        nameNotificationBadge.textContent = cantidad;
        nameNotificationBadge.style.display = 'block';
        sound.currentTime = 0;
        sound.play().catch(e => console.warn("No se pudo reproducir el sonido:", e));
    }, 1500);
    });





    //funcion para verificar los mensajes nuevos
    async function fetchMensajes() {
        
        fetch(`/obtener-notificaciones-usuario/${userId}/`)
            .then(response => response.json())
            .then(data => {
                mensajes = data;
                var listveri = data.filter(msg => msg.not_read === true);
                cantidad = listveri.length;
                nameNotificationBadge.textContent = cantidad;
                if (cantidad > 0) { 
                    nameNotificationBadge.style.display = 'block'; 
                }
            })
            .catch(error => {
                console.error('Error al obtener notificaciones:', error);
            });
    }

    


    
    //marcar todos los mensajes como leidos
    function marcarNotificacionesLeidas() {
      cantidad = 0;
      fetch(`/marcar-notificaciones-leidas/${userId}`)
      .then(data => {console.log(data);})
      .catch(error => {
        console.error('Error al marcar notificaciones como leidas:', error);
      });
    }
    
    
    
    //al darle clik al icono d enotificaciones se muestra el panel de notificaciones//

  // **NOTIFICACIONES**
  const notificationContent = document.getElementById('notification-content');



 function openNotifications() {
  console.log("openNotifications");
  const notificationBadge = document.querySelector('.notification-badge');
  if(notificationBadge) notificationBadge.style.display = 'none';
  
  notificationContent.innerHTML = '';
  marcarNotificacionesLeidas();
  
  fetch(`/obtener-notificaciones-usuario/${userId}/`)
    .then(response => response.json())
    .then(data => {
      mensajes = data;
      
      if(mensajes.length === 0 && mensajes.filter(msg => msg.not_estado === true).length === 0) {
        notificationContent.innerHTML = '<div class="px-6 py-8 text-center text-gray-500 text-sm">No tienes notificaciones</div>';
        return;
      }
      
      mensajes.forEach(msg => {
        if(msg.not_estado === true){
          // Crear el contenedor de la notificación
          const notificationItem = document.createElement("div");
          notificationItem.classList.add("px-6", "py-4", "hover:bg-gray-50", "cursor-pointer", "border-b", "border-gray-100", "transition-colors");
          
          // Crear el contenedor flex
          const flexContainer = document.createElement("div");
          flexContainer.classList.add("flex", "gap-4");
          
          // Crear el icono
          const iconDiv = document.createElement("div");
          iconDiv.classList.add("w-10", "h-10", "bg-gradient-to-br", "from-teal-600", "to-teal-800", "rounded-lg", "flex", "items-center", "justify-center", "flex-shrink-0");
          iconDiv.innerHTML = `
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          `;
          
          // Crear el contenedor del contenido
          const contentDiv = document.createElement("div");
          contentDiv.classList.add("flex-1");
          
          // Título
          const titulo = document.createElement("div");
          titulo.classList.add("font-semibold", "text-gray-900", "text-sm", "mb-1");
          titulo.textContent = `Póliza: ${msg.not_poliza.numero_poliza || "N/A"}`;
          
          // Mensaje
          const mensaje = document.createElement("div");
          mensaje.classList.add("text-gray-600", "text-sm", "mb-2");
          mensaje.textContent = msg.not_mensaje || "Sin mensaje";
          
          // Información adicional
          const infoDiv = document.createElement("div");
          infoDiv.classList.add("text-gray-400", "text-xs", "mt-2", "space-y-1");
          infoDiv.innerHTML = `
            <div>ID: ${msg.not_id || "N/A"}</div>
            <div>Fecha proceso: ${msg.not_fecha_proceso || "N/A"}</div>
            <div>Creado: ${msg.not_fecha_creacion || "N/A"}</div>
          `;
          
          contentDiv.appendChild(titulo);
          contentDiv.appendChild(mensaje);
          contentDiv.appendChild(infoDiv);
          
          flexContainer.appendChild(iconDiv);
          flexContainer.appendChild(contentDiv);
          
          notificationItem.appendChild(flexContainer);
          notificationContent.appendChild(notificationItem);
        }
      });
    })
    .catch(error => {
      console.error('Error al obtener notificaciones:', error);
      notificationContent.innerHTML = '<div class="px-6 py-8 text-center text-red-500 text-sm">Error al cargar notificaciones</div>';
    });
}
 
  fetchMensajes();



document.addEventListener('DOMContentLoaded', function() {


  
  // Función para obtener el token CSRF
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>
