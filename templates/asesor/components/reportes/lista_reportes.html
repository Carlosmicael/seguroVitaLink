{% extends "master/sideBar/sidebar_asesor.html" %}
{% load static %}
{% block title %}Gesti√≥n de Reportes{% endblock %}

{% block content %}
{% include "master/appBar/appBar.html" %}
<!-- En el head o antes de usar -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .reportes-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Banner Superior con Vista Previa del √öltimo Reporte */
    .banner-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        color: white;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        min-height: 200px;
    }

    .banner-content {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 30px;
        align-items: center;
    }

    .banner-info h1 {
        font-size: 32px;
        font-weight: 800;
        margin-bottom: 15px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .banner-info p {
        font-size: 16px;
        opacity: 0.95;
        margin-bottom: 20px;
    }

    .banner-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 20px;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .stat-card .number {
        font-size: 28px;
        font-weight: 800;
        display: block;
    }

    .stat-card .label {
        font-size: 12px;
        opacity: 0.9;
        margin-top: 5px;
    }

    /* Vista Previa del Archivo */
    .preview-container {
        background: white;
        border-radius: 15px;
        padding: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        height: 250px;
        position: relative;
    }

    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f1f5f9;
    }

    .preview-title {
        font-size: 14px;
        font-weight: 700;
        color: #1e293b;
    }

    .preview-badge {
        background: #10b981;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
    }

    .preview-frame {
        width: 100%;
        height: 180px;
        border-radius: 10px;
        overflow: hidden;
        background: #f8fafc;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .preview-frame iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    .preview-frame img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .no-preview {
        color: #94a3b8;
        font-size: 14px;
        text-align: center;
    }

    /* Estad√≠sticas Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    .mini-stat-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        border-left: 4px solid #667eea;
    }

    .mini-stat-card.nuevos { border-left-color: #3b82f6; }
    .mini-stat-card.enviados { border-left-color: #10b981; }
    .mini-stat-card.evaluados { border-left-color: #f59e0b; }

    .mini-stat-card h3 {
        font-size: 28px;
        font-weight: 800;
        color: #1e293b;
        margin-bottom: 5px;
    }

    .mini-stat-card p {
        font-size: 13px;
        color: #64748b;
        font-weight: 500;
    }

    /* Tabla de Reportes */
    .table-section {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.06);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .section-header h2 {
        font-size: 22px;
        font-weight: 800;
        color: #1e293b;
    }

    .search-box {
        position: relative;
        width: 300px;
    }

    .search-box input {
        width: 100%;
        padding: 10px 40px 10px 15px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s;
    }

    .search-box input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 18px;
    }

    /* Tabla Moderna */
    .reportes-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 10px;
    }

    .reportes-table thead th {
        background: #f8fafc;
        padding: 15px;
        text-align: left;
        font-size: 13px;
        font-weight: 700;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none;
    }

    .reportes-table thead th:first-child {
        border-radius: 10px 0 0 10px;
    }

    .reportes-table thead th:last-child {
        border-radius: 0 10px 10px 0;
    }

    .reportes-table tbody tr {
        background: white;
        transition: all 0.3s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        border-radius: 10px;
    }

    .reportes-table tbody tr:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .reportes-table tbody td {
        padding: 18px 15px;
        border: none;
        background: white;
        color: #334155;
        font-size: 14px;
    }

    .reportes-table tbody td:first-child {
        border-radius: 10px 0 0 10px;
    }

    .reportes-table tbody td:last-child {
        border-radius: 0 10px 10px 0;
    }

    /* ID Badge */
    .id-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 6px 14px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 13px;
        display: inline-block;
    }

    /* Beneficiario Info */
    .beneficiario-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 16px;
    }

    .beneficiario-details .name {
        font-weight: 700;
        color: #1e293b;
        display: block;
        margin-bottom: 3px;
    }

    .beneficiario-details .relation {
        font-size: 12px;
        color: #64748b;
    }

    /* Contacto */
    .contacto-info {
        font-size: 13px;
    }

    .contacto-info .phone {
        display: block;
        color: #1e293b;
        font-weight: 600;
        margin-bottom: 3px;
    }

    .contacto-info .email {
        display: block;
        color: #64748b;
        font-size: 12px;
    }

    /* Estado Badges */
    .estado-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .estado-badge.nuevo {
        background: #dbeafe;
        color: #1e40af;
    }

    .estado-badge.enviado {
        background: #d1fae5;
        color: #065f46;
    }

    .estado-badge.descartado {
        background: #fee2e2;
        color: #991b1b;
    }

    .evaluado-check {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #10b981;
        color: white;
        font-size: 12px;
        text-align: center;
        line-height: 20px;
        margin-left: 8px;
    }

    /* Botones de Acci√≥n */
    .action-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .btn-action {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-ver {
        background: #eff6ff;
        color: #2563eb;
    }

    .btn-ver:hover {
        background: #2563eb;
        color: white;
        transform: scale(1.1);
    }

    .btn-enviar {
        background: #f0fdf4;
        color: #16a34a;
    }

    .btn-enviar:hover {
        background: #16a34a;
        color: white;
        transform: scale(1.1);
    }

    .btn-eliminar {
        background: #fef2f2;
        color: #dc2626;
    }

    .btn-eliminar:hover {
        background: #dc2626;
        color: white;
        transform: scale(1.1);
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background-color: white;
        margin: 3% auto;
        padding: 0;
        border-radius: 20px;
        width: 90%;
        max-width: 900px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        animation: slideIn 0.3s;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    @keyframes slideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px 30px;
        border-radius: 20px 20px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        font-size: 24px;
        font-weight: 800;
    }

    .close-modal {
        color: white;
        font-size: 32px;
        font-weight: bold;
        cursor: pointer;
        background: rgba(255,255,255,0.2);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    .close-modal:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 30px;
        overflow-y: auto;
        flex: 1;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 25px;
        margin-bottom: 25px;
    }

    .detail-item {
        background: #f8fafc;
        padding: 20px;
        border-radius: 12px;
        border-left: 4px solid #667eea;
    }

    .detail-item label {
        display: block;
        font-size: 12px;
        font-weight: 700;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .detail-item .value {
        font-size: 15px;
        color: #1e293b;
        font-weight: 600;
    }

    .detail-full {
        grid-column: 1 / -1;
    }

    .descripcion-box {
        background: #f8fafc;
        padding: 20px;
        border-radius: 12px;
        border-left: 4px solid #667eea;
        margin-bottom: 25px;
    }

    .descripcion-box label {
        display: block;
        font-size: 12px;
        font-weight: 700;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
    }

    .descripcion-box .value {
        font-size: 14px;
        color: #334155;
        line-height: 1.8;
    }

    .archivo-section {
        background: #f8fafc;
        padding: 20px;
        border-radius: 12px;
        margin-top: 20px;
    }

    .archivo-section h3 {
        font-size: 16px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .archivo-viewer {
        background: white;
        border-radius: 10px;
        padding: 15px;
        min-height: 400px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .archivo-viewer iframe {
        width: 100%;
        height: 500px;
        border: none;
        border-radius: 8px;
    }

    .archivo-viewer img {
        width: 100%;
        height: auto;
        border-radius: 8px;
    }

    .no-archivo {
        text-align: center;
        padding: 60px 20px;
        color: #94a3b8;
    }

    .no-archivo-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }

    .download-btn {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        margin-top: 15px;
        transition: all 0.3s;
    }

    .download-btn:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .banner-content {
            grid-template-columns: 1fr;
        }

        .preview-container {
            height: 200px;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .detail-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .reportes-table {
            font-size: 12px;
        }

        .action-buttons {
            flex-direction: column;
        }

        .banner-stats {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="reportes-container">
    
    <!-- Banner Superior con Vista Previa -->
    <div class="banner-header">
        <div class="banner-content">
            <div class="banner-info">
                <h1>üìã Gesti√≥n de Reportes</h1>
                <p>Sistema integral de administraci√≥n y seguimiento de reportes de eventos</p>
                
                <div class="banner-stats">
                    <div class="stat-card">
                        <span class="number">{{ total_reportes }}</span>
                        <span class="label">Total Reportes</span>
                    </div>
                    <div class="stat-card">
                        <span class="number">{{ reportes_nuevos }}</span>
                        <span class="label">Nuevos</span>
                    </div>
                    <div class="stat-card">
                        <span class="number">{{ reportes_enviados }}</span>
                        <span class="label">Procesados</span>
                    </div>
                </div>
            </div>
            
            <!-- Vista Previa del √öltimo Reporte -->
            <div class="preview-container">
                <div class="preview-header">
                    <span class="preview-title">üìÑ √öltimo Reporte</span>
                    {% if ultimo_reporte %}
                    <span class="preview-badge">ID #{{ ultimo_reporte.id }}</span>
                    {% endif %}
                </div>
                <div class="preview-frame" id="pdf-preview-container">
                    {% if ultimo_reporte and ultimo_reporte.archivo_documento %}
                        {% if ultimo_reporte.archivo_documento.url|slice:"-4:"|lower == ".pdf" %}
                            <div id="pdf-viewer" style="width: 100%; height: 100%; overflow: auto;">
                                <canvas id="pdf-canvas" style="width: 100%; height: auto;"></canvas>
                                <div id="pdf-controls" style="display: none;">
                                    <button onclick="prevPage()">‚Üê</button>
                                    <span id="page-num">1</span> / <span id="page-count">1</span>
                                    <button onclick="nextPage()">‚Üí</button>
                                </div>
                            </div>
                        {% elif ultimo_reporte.archivo_documento.url|slice:"-4:"|lower == ".jpg" or ultimo_reporte.archivo_documento.url|slice:"-4:"|lower == ".png" or ultimo_reporte.archivo_documento.url|slice:"-5:"|lower == ".jpeg" %}
                            <img src="{{ ultimo_reporte.archivo_documento.url }}" alt="Vista previa" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        {% else %}
                            <div class="no-preview">
                                <div style="font-size:40px;margin-bottom:10px;">üìé</div>
                                <div>{{ ultimo_reporte.archivo_documento.name|slice:"-30:" }}</div>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="no-preview">
                            <div style="font-size:40px;margin-bottom:10px;">üì≠</div>
                            <div>Sin archivo adjunto</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Estad√≠sticas R√°pidas -->
    <div class="stats-grid">
        <div class="mini-stat-card">
            <h3>{{ total_reportes }}</h3>
            <p>üìä Total de Reportes</p>
        </div>
        <div class="mini-stat-card nuevos">
            <h3>{{ reportes_nuevos }}</h3>
            <p>üÜï Reportes Nuevos</p>
        </div>
        <div class="mini-stat-card enviados">
            <h3>{{ reportes_enviados }}</h3>
            <p>‚úÖ Reportes Enviados</p>
        </div>
        <div class="mini-stat-card evaluados">
            <h3>{{ reportes_evaluados }}</h3>
            <p>‚≠ê Reportes Evaluados</p>
        </div>
    </div>

    <!-- Tabla de Reportes -->
    <div class="table-section">
        <div class="section-header">
            <h2>Lista de Reportes</h2>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Buscar reportes...">
                <span class="search-icon">üîç</span>
            </div>
        </div>

        <table class="reportes-table" id="reportesTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Beneficiario</th>
                    <th>Contacto</th>
                    <th>Estado</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for r in reportes %}
                <tr>
                    <td>
                        <span class="id-badge">#{{ r.id }}</span>
                    </td>
                    <td>
                        <div class="beneficiario-info">
                            <div class="avatar">
                                {{ r.nombre_beneficiario|slice:":1"|upper }}
                            </div>
                            <div class="beneficiario-details">
                                <span class="name">{{ r.nombre_beneficiario }}</span>
                                <span class="relation">{{ r.relacion_beneficiario }}</span>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="contacto-info">
                            <span class="phone">üìû {{ r.telefono }}</span>
                            <span class="email">‚úâÔ∏è {{ r.email }}</span>
                        </div>
                    </td>
                    <td>
                        <span class="estado-badge {{ r.estado }}">
                            {% if r.estado == 'nuevo' %}
                                üÜï Nuevo
                            {% elif r.estado == 'enviado' %}
                                ‚úÖ Enviado
                            {% elif r.estado == 'descartado' %}
                                ‚ùå Descartado
                            {% endif %}
                        </span>
                        {% if r.evaluado %}
                            <span class="evaluado-check" title="Evaluado">‚úì</span>
                        {% endif %}
                    </td>
                    <td>
                        {{ r.fecha_creacion|date:"d/m/Y" }}<br>
                        <small style="color:#64748b;">{{ r.fecha_creacion|date:"h:i A" }}</small>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-ver" onclick="verReporte({{ r.id }})" title="Ver detalles">
                                üëÅÔ∏è
                            </button>
                            <button class="btn-action btn-enviar" onclick="enviarReporte({{ r.id }})" title="Marcar como enviado">
                                üì§
                            </button>
                            <button class="btn-action btn-eliminar" onclick="confirmarEliminar({{ r.id }})" title="Eliminar">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="text-align:center;padding:40px;color:#94a3b8;">
                        <div style="font-size:48px;margin-bottom:10px;">üì≠</div>
                        <div style="font-size:16px;">No hay reportes disponibles</div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal para Ver Detalles del Reporte -->
<div id="modalReporte" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìÑ Detalles del Reporte <span id="modalReporteId"></span></h2>
            <span class="close-modal" onclick="cerrarModal()">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Grid de Informaci√≥n -->
            <div class="detail-grid">
                <div class="detail-item">
                    <label>üë§ Beneficiario</label>
                    <div class="value" id="modalBeneficiario"></div>
                </div>
                <div class="detail-item">
                    <label>üîó Relaci√≥n</label>
                    <div class="value" id="modalRelacion"></div>
                </div>
                <div class="detail-item">
                    <label>üìû Tel√©fono</label>
                    <div class="value" id="modalTelefono"></div>
                </div>
                <div class="detail-item">
                    <label>‚úâÔ∏è Email</label>
                    <div class="value" id="modalEmail"></div>
                </div>
                <div class="detail-item">
                    <label>üìÖ Fecha de Creaci√≥n</label>
                    <div class="value" id="modalFecha"></div>
                </div>
                <div class="detail-item">
                    <label>üìä Estado</label>
                    <div class="value" id="modalEstado"></div>
                </div>
            </div>

            <!-- Descripci√≥n -->
            <div class="descripcion-box">
                <label>üìù Descripci√≥n del Evento</label>
                <div class="value" id="modalDescripcion"></div>
            </div>

            <!-- Secci√≥n de Archivo Adjunto -->
            <div class="archivo-section">
                <h3>üìé Archivo Adjunto</h3>
                <div class="archivo-viewer" id="archivoViewer">
                    <!-- El contenido se cargar√° din√°micamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    function verReporte(id) {
    fetch(`/reportes/${id}/`)
        .then(response => response.json())
        .then(data => {
            // Llenar informaci√≥n b√°sica
            document.getElementById('modalReporteId').textContent = `#${data.id}`;
            document.getElementById('modalBeneficiario').textContent = data.beneficiario;
            document.getElementById('modalRelacion').textContent = data.relacion;
            document.getElementById('modalTelefono').textContent = data.telefono;
            document.getElementById('modalEmail').textContent = data.email;
            document.getElementById('modalFecha').textContent = data.fecha;
            document.getElementById('modalDescripcion').textContent = data.descripcion;

            // Estado con badge
            let estadoBadge = '';
            if (data.estado === 'nuevo') {
                estadoBadge = '<span class="estado-badge nuevo">üÜï Nuevo</span>';
            } else if (data.estado === 'enviado') {
                estadoBadge = '<span class="estado-badge enviado">‚úÖ Enviado</span>';
            } else if (data.estado === 'descartado') {
                estadoBadge = '<span class="estado-badge descartado">‚ùå Descartado</span>';
            }
            
            if (data.evaluado) {
                estadoBadge += ' <span class="evaluado-check">‚úì</span>';
            }
            
            document.getElementById('modalEstado').innerHTML = estadoBadge;

            // Mostrar archivo adjunto - USANDO EL MISMO ENFOQUE QUE EN EL PREVIEW
            const archivoViewer = document.getElementById('archivoViewer');
            
            if (data.archivo_url) {
                let contenidoArchivo = '';
                
                // Usar archivo_tipo que viene del servidor
                if (data.archivo_tipo === 'pdf') {
                    contenidoArchivo = `
                        <div style="margin-bottom: 10px; font-size: 14px; color: #64748b;">
                            üìÑ ${data.archivo_nombre}
                        </div>
                        <embed 
                            src="${data.archivo_url}" 
                            type="application/pdf" 
                            width="100%" 
                            height="500px"
                            style="border-radius: 8px; border: 1px solid #e2e8f0;"
                        >
                        <div style="margin-top: 15px; text-align: center;">
                            <a href="${data.archivo_url}" target="_blank" class="download-btn">
                                üì• Descargar PDF
                            </a>
                        </div>
                    `;
                } else if (data.archivo_tipo === 'imagen') {
                    contenidoArchivo = `
                        <div style="margin-bottom: 10px; font-size: 14px; color: #64748b;">
                            üñºÔ∏è ${data.archivo_nombre}
                        </div>
                        <img src="${data.archivo_url}" 
                             alt="Archivo adjunto" 
                             style="width: 100%; max-height: 500px; object-fit: contain; border-radius: 8px; border: 1px solid #e2e8f0;"
                             onerror="this.onerror=null; this.parentElement.innerHTML+='<div style=\\'color:#ef4444;padding:20px;background:#fef2f2;border-radius:8px;\\'>‚ùå Error al cargar la imagen</div>'">
                        <div style="margin-top: 15px; text-align: center;">
                            <a href="${data.archivo_url}" target="_blank" class="download-btn">
                                üì• Descargar Imagen
                            </a>
                        </div>
                    `;
                } else if (data.archivo_tipo === 'word') {
                    contenidoArchivo = `
                        <div style="text-align: center; padding: 30px 20px;">
                            <div style="font-size: 60px; margin-bottom: 20px; color: #2b579a;">üìù</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #1e293b;">
                                Documento de Word
                            </div>
                            <div style="font-size: 14px; color: #64748b; margin-bottom: 25px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                                ${data.archivo_nombre}
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <a href="https://docs.google.com/viewer?url=${encodeURIComponent(window.location.origin + data.archivo_url)}&embedded=true" 
                                   target="_blank" 
                                   class="download-btn" 
                                   style="background: #4285f4;">
                                    üëÅÔ∏è Ver en Google Docs
                                </a>
                                <a href="${data.archivo_url}" target="_blank" class="download-btn">
                                    üì• Descargar
                                </a>
                            </div>
                        </div>
                    `;
                } else if (data.archivo_tipo === 'excel') {
                    contenidoArchivo = `
                        <div style="text-align: center; padding: 30px 20px;">
                            <div style="font-size: 60px; margin-bottom: 20px; color: #217346;">üìä</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #1e293b;">
                                Hoja de C√°lculo Excel
                            </div>
                            <div style="font-size: 14px; color: #64748b; margin-bottom: 25px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                                ${data.archivo_nombre}
                            </div>
                            <a href="${data.archivo_url}" target="_blank" class="download-btn">
                                üì• Descargar Archivo
                            </a>
                        </div>
                    `;
                } else {
                    contenidoArchivo = `
                        <div class="no-archivo">
                            <div class="no-archivo-icon">üìé</div>
                            <div style="font-size:16px;margin-bottom:10px;">Archivo adjunto</div>
                            <div style="font-size:14px;color:#64748b;margin-bottom:15px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                                ${data.archivo_nombre}
                            </div>
                            <div style="font-size:12px;color:#94a3b8;margin-bottom:20px;padding: 8px 12px; background: #f1f5f9; border-radius: 6px;">
                                Tipo: ${data.archivo_tipo ? data.archivo_tipo.toUpperCase() : 'DESCONOCIDO'}
                            </div>
                            <a href="${data.archivo_url}" target="_blank" class="download-btn">
                                üì• Descargar Archivo
                            </a>
                        </div>
                    `;
                }
                
                archivoViewer.innerHTML = contenidoArchivo;
            } else {
                archivoViewer.innerHTML = `
                    <div class="no-archivo">
                        <div class="no-archivo-icon">üì≠</div>
                        <div style="font-size:16px;">No hay archivo adjunto</div>
                    </div>
                `;
            }

            // Mostrar modal
            document.getElementById('modalReporte').style.display = 'block';
            
            // Si es PDF, ajustar el height din√°micamente
            if (data.archivo_tipo === 'pdf') {
                setTimeout(() => {
                    const embed = archivoViewer.querySelector('embed');
                    if (embed) {
                        embed.style.height = '500px';
                    }
                }, 100);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los detalles del reporte');
        });
    }


    function cerrarModal() {
        document.getElementById('modalReporte').style.display = 'none';
    }

    window.onclick = function(event) {
        const modal = document.getElementById('modalReporte');
        if (event.target === modal) {
            cerrarModal();
        }
    }

    function enviarReporte(id) {
        if (confirm('¬øDesea marcar este reporte como enviado?')) {
            const formData = new FormData();
            formData.append('estado', 'enviado');
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch(`/reportes/cambiar-estado/${id}/`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Reporte marcado como enviado exitosamente');
                    location.reload();
                } else {
                    alert('Error al actualizar el estado del reporte');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al procesar la solicitud');
            });
        }
    }

    function confirmarEliminar(id) {
        if (confirm('¬øEst√° seguro de que desea eliminar este reporte? Esta acci√≥n no se puede deshacer.')) {
            window.location.href = `/reportes/eliminar/${id}/`;
        }
    }

    document.getElementById('searchInput').addEventListener('keyup', function() {
        const searchValue = this.value.toLowerCase();
        const table = document.getElementById('reportesTable');
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const text = row.textContent.toLowerCase();
            
            if (text.includes(searchValue)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            cerrarModal();
        }
    });


    // Variables para PDF.js
    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    let scale = 1.0;

    function renderPage(num) {
        if (!pdfDoc) return;
        
        pageRendering = true;
        
        pdfDoc.getPage(num).then(function(page) {
            const canvas = document.getElementById('pdf-canvas');
            const ctx = canvas.getContext('2d');
            const viewport = page.getViewport({ scale: scale });
            
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            
            const renderTask = page.render(renderContext);
            
            renderTask.promise.then(function() {
                pageRendering = false;
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
            });
            
            document.getElementById('page-num').textContent = num;
        });
    }

    function loadPdf(url) {
        pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
            pdfDoc = pdfDoc_;
            document.getElementById('page-count').textContent = pdfDoc.numPages;
            document.getElementById('pdf-controls').style.display = 'block';
            renderPage(pageNum);
        });
    }

    function prevPage() {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    }

    function nextPage() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    }

    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    {% if ultimo_reporte and ultimo_reporte.archivo_documento and ultimo_reporte.archivo_documento.url|slice:"-4:"|lower == ".pdf" %}
        document.addEventListener('DOMContentLoaded', function() {
            loadPdf('{{ ultimo_reporte.archivo_documento.url }}');
        });
    {% endif %}
</script>

{% endblock %}