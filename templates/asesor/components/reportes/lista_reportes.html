{% extends "master/sideBar/sidebar_asesor.html" %}
{% load static %}
{% block title %}Gestión de Reportes{% endblock %}

{% block content %}
{% include "master/appBar/appBar.html" %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap');

    :root {
        --primary: #0f172a;
        --secondary: #64748b;
        --accent: #10b981;
        
        --bg-body: #f1f5f9;
        
        /* Ajuste para el cristal */
        --glass-bg: rgba(255, 255, 255, 0.65); /* Blanco semitransparente */
        --glass-border: rgba(255, 255, 255, 0.8);
        --glass-blur: 16px;
    }

    /* 1. FONDO CON DESTELLOS PARA QUE EL CRISTAL RESALTE */
    .reportes-container {
        padding: 32px;
        max-width: 1600px;
        margin: 0 auto;
        font-family: 'Manrope', sans-serif;
        min-height: 100vh;
        background-color: var(--bg-body);
        position: relative;
        overflow: hidden;
        /* Destellos de fondo sutiles */
        background-image: 
            radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.08) 0%, transparent 40%),
            radial-gradient(circle at 90% 10%, rgba(16, 185, 129, 0.08) 0%, transparent 40%);
    }

    /* 2. TARJETAS KPI TIPO CRISTAL OPACO */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
        position: relative; 
        z-index: 2; /* Encima del fondo */
    }

    .kpi-card {
        /* Efecto Cristal */
        background: var(--glass-bg);
        backdrop-filter: blur(var(--glass-blur));
        -webkit-backdrop-filter: blur(var(--glass-blur));
        border: 1px solid white; /* Borde blanco brillante */
        box-shadow: 
            0 4px 6px -1px rgba(0, 0, 0, 0.05),
            0 2px 4px -1px rgba(0, 0, 0, 0.03),
            inset 0 0 20px rgba(255, 255, 255, 0.5); /* Brillo interior */
        
        padding: 24px;
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .kpi-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        background: rgba(255, 255, 255, 0.75); /* Más opaco al pasar el mouse */
    }

    .kpi-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .kpi-icon {
        padding: 10px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        /* Los iconos ahora tienen fondo sólido para contraste */
        background: white; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .kpi-icon svg { width: 22px; height: 22px; }

    /* Colores de acento para los iconos y textos */
    .kpi-blue .kpi-icon { color: #3b82f6; }
    .kpi-green .kpi-icon { color: #10b981; }
    .kpi-orange .kpi-icon { color: #f97316; }
    .kpi-purple .kpi-icon { color: #8b5cf6; }

    .kpi-value {
        font-size: 36px;
        font-weight: 800;
        color: var(--primary);
        line-height: 1;
        margin-bottom: 4px;
        /* Sutil sombra al texto para que resalte en el cristal */
        text-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .kpi-label {
        font-size: 13px;
        font-weight: 700;
        color: var(--secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Resto de estilos (Header, Tabla, Modal) se mantienen limpios */
    .header-section { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 32px; }
    .header-title h1 { font-size: 28px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 12px; }
    .header-icon-box { width: 48px; height: 48px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3); }
    
    .table-container { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; overflow: hidden; }
    .table-toolbar { padding: 20px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #fcfcfc; }
    .table-title { font-size: 18px; font-weight: 700; color: var(--primary); }
    .search-wrapper { position: relative; width: 300px; }
    .search-wrapper input { width: 100%; padding: 10px 16px 10px 40px; border-radius: 10px; border: 1px solid #e2e8f0; }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
    
    .custom-table { width: 100%; border-collapse: separate; border-spacing: 0; }
    .custom-table th { background: #f8fafc; padding: 16px 24px; text-align: left; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--secondary); border-bottom: 1px solid #e2e8f0; }
    .custom-table td { padding: 16px 24px; border-bottom: 1px solid #e2e8f0; color: var(--primary); font-size: 14px; vertical-align: middle; }
    .custom-table tr:hover td { background-color: #f8fafc; }
    
    .user-cell { display: flex; align-items: center; gap: 12px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: #e2e8f0; color: var(--secondary); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; }
    .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
    .status-nuevo { background: #eff6ff; color: #1d4ed8; }
    .status-enviado { background: #ecfdf5; color: #047857; }
    .status-descartado { background: #fef2f2; color: #b91c1c; }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    
    .action-btn-group { display: flex; gap: 8px; }
    .btn-icon { width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e2e8f0; background: white; color: var(--secondary); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
    .btn-icon:hover { transform: translateY(-2px); }
    .btn-icon.view:hover { border-color: #3b82f6; color: #3b82f6; background: #eff6ff; }
    .btn-icon.send:hover { border-color: #10b981; color: #10b981; background: #ecfdf5; }
    .btn-icon.delete:hover { border-color: #ef4444; color: #ef4444; background: #fef2f2; }

    /* Modal styles (Mismos que antes) */
    .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 1000; padding: 20px; align-items: center; justify-content: center; }
    .modal-content { background: white; border-radius: 20px; width: 100%; max-width: 900px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); overflow: hidden; animation: modalSlide 0.3s ease-out; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
    .close-btn { background: transparent; border: none; font-size: 24px; color: var(--secondary); cursor: pointer; }
    .modal-body { padding: 24px; max-height: 80vh; overflow-y: auto; }
    .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 24px; }
    .detail-group label { display: block; font-size: 11px; text-transform: uppercase; color: var(--secondary); font-weight: 700; margin-bottom: 6px; }
    .detail-group p { font-size: 15px; color: var(--primary); font-weight: 500; background: #f8fafc; padding: 10px 14px; border-radius: 8px; border: 1px solid #e2e8f0; }
    .pdf-viewer-container { border: 1px solid #e2e8f0; border-radius: 12px; background: #f1f5f9; height: 400px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    @keyframes modalSlide { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>

<div class="reportes-container">
    
    <div class="header-section">
        <div class="header-title">
            <h1>
                <div class="header-icon-box">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                </div>
                Gestión de Reportes
            </h1>
            <p>Monitoreo y administración centralizada de incidencias</p>
        </div>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card kpi-blue">
            <div class="kpi-header">
                <span class="kpi-label">Total Reportes</span>
                <div class="kpi-icon"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div>
            </div>
            <span class="kpi-value">{{ total_reportes }}</span>
        </div>

        <div class="kpi-card kpi-orange">
            <div class="kpi-header">
                <span class="kpi-label">Nuevos</span>
                <div class="kpi-icon"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
            </div>
            <span class="kpi-value">{{ reportes_nuevos }}</span>
        </div>

        <div class="kpi-card kpi-green">
            <div class="kpi-header">
                <span class="kpi-label">Enviados</span>
                <div class="kpi-icon"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
            </div>
            <span class="kpi-value">{{ reportes_enviados }}</span>
        </div>

        <div class="kpi-card kpi-purple">
            <div class="kpi-header">
                <span class="kpi-label">Evaluados</span>
                <div class="kpi-icon"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg></div>
            </div>
            <span class="kpi-value">{{ reportes_evaluados }}</span>
        </div>
    </div>

    <div class="table-container">
        <div class="table-toolbar">
            <h2 class="table-title">Listado Reciente</h2>
            <div class="search-wrapper">
                <svg class="search-icon" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
                <input type="text" id="searchInput" placeholder="Buscar por nombre, ID o email...">
            </div>
        </div>

        <div style="overflow-x: auto;">
            <table class="custom-table" id="reportesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Beneficiario</th>
                        <th>Contacto</th>
                        <th>Estado</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in reportes %}
                    <tr>
                        <td><span style="font-family: monospace; color: var(--secondary);">#{{ r.id }}</span></td>
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar">{{ r.nombre_beneficiario|slice:":1"|upper }}</div>
                                <div class="user-info">
                                    <span class="name">{{ r.nombre_beneficiario }}</span>
                                    <span class="sub">{{ r.relacion_beneficiario }}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="user-info">
                                <span class="sub" style="display:flex; align-items:center; gap:4px;">
                                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                    {{ r.email }}
                                </span>
                                <span class="sub" style="display:flex; align-items:center; gap:4px; margin-top:2px;">
                                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                                    {{ r.telefono }}
                                </span>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge status-{{ r.estado }}">
                                <span class="status-dot"></span>
                                {{ r.estado|title }}
                            </span>
                        </td>
                        <td>
                            <div class="user-info">
                                <span class="name" style="font-size: 13px;">{{ r.fecha_creacion|date:"d M, Y" }}</span>
                                <span class="sub">{{ r.fecha_creacion|date:"h:i A" }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="action-btn-group">
                                <button class="btn-icon view" onclick="verReporte({{ r.id }})" title="Ver detalles">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                </button>
                                <button class="btn-icon send" onclick="enviarReporte({{ r.id }})" title="Procesar">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                </button>
                                <button class="btn-icon delete" onclick="confirmarEliminar({{ r.id }})" title="Eliminar">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            <p style="color: var(--secondary);">No se encontraron reportes</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="modalReporte" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Detalle del Reporte <span id="modalReporteId" style="color: var(--secondary);"></span></h2>
            <button class="close-btn" onclick="cerrarModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="detail-grid">
                <div class="detail-group">
                    <label>Beneficiario</label>
                    <p id="modalBeneficiario"></p>
                </div>
                <div class="detail-group">
                    <label>Relación</label>
                    <p id="modalRelacion"></p>
                </div>
                <div class="detail-group">
                    <label>Teléfono</label>
                    <p id="modalTelefono"></p>
                </div>
                <div class="detail-group">
                    <label>Email</label>
                    <p id="modalEmail"></p>
                </div>
            </div>

            <div class="detail-group" style="margin-bottom: 24px;">
                <label>Descripción del Evento</label>
                <p id="modalDescripcion" style="min-height: 60px;"></p>
            </div>

            <div class="detail-group">
                <label>Archivo Adjunto</label>
                <div class="pdf-viewer-container" id="archivoViewer">
                    <span style="color: var(--secondary);">Cargando visualización...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    function verReporte(id) {
    fetch(`/reportes/${id}/`)
        .then(response => response.json())
        .then(data => {
            // Llenar información básica
            document.getElementById('modalReporteId').textContent = `#${data.id}`;
            document.getElementById('modalBeneficiario').textContent = data.beneficiario;
            document.getElementById('modalRelacion').textContent = data.relacion;
            document.getElementById('modalTelefono').textContent = data.telefono;
            document.getElementById('modalEmail').textContent = data.email;
            document.getElementById('modalFecha').textContent = data.fecha;
            document.getElementById('modalDescripcion').textContent = data.descripcion;

            // Estado con badge
            const iconPlus = '<svg class="inline-icon muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14"></path><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14"></path></svg>';
            const iconCheck = '<svg class="inline-icon muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M20 6L9 17l-5-5"></path></svg>';
            const iconTrash = '<svg class="inline-icon muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M3 6h18"></path><path stroke-linecap="round" stroke-linejoin="round" d="M8 6V4h8v2"></path><path stroke-linecap="round" stroke-linejoin="round" d="M19 6l-1 14H6L5 6"></path></svg>';
            const iconEvaluado = '<svg class="inline-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M20 6L9 17l-5-5"></path></svg>';
            let estadoBadge = '';
            if (data.estado === 'nuevo') {
                estadoBadge = `<span class="estado-badge nuevo">${iconPlus}Nuevo</span>`;
            } else if (data.estado === 'enviado') {
                estadoBadge = `<span class="estado-badge enviado">${iconCheck}Enviado</span>`;
            } else if (data.estado === 'descartado') {
                estadoBadge = `<span class="estado-badge descartado">${iconTrash}Descartado</span>`;
            }
            
            if (data.evaluado) {
                estadoBadge += ` <span class="evaluado-check">${iconEvaluado}</span>`;
            }
            
            document.getElementById('modalEstado').innerHTML = estadoBadge;

            // Mostrar archivo adjunto - USANDO EL MISMO ENFOQUE QUE EN EL PREVIEW
            const archivoViewer = document.getElementById('archivoViewer');
            const iconDownload = '<svg class="inline-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5v10"></path><path stroke-linecap="round" stroke-linejoin="round" d="M8 11l4 4 4-4"></path><path stroke-linecap="round" stroke-linejoin="round" d="M5 19h14"></path></svg>';
            const iconFile = '<svg class="inline-icon muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M7 3h7l4 4v14H7z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M14 3v4h4"></path></svg>';
            const iconImage = '<svg class="inline-icon muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="5" width="18" height="14" rx="2"></rect><path stroke-linecap="round" stroke-linejoin="round" d="M8 13l3-3 5 5"></path><circle cx="9" cy="9" r="1.5"></circle></svg>';
            const iconDoc = '<svg class="inline-icon muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M7 3h7l4 4v14H7z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M14 3v4h4"></path><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6"></path><path stroke-linecap="round" stroke-linejoin="round" d="M9 17h6"></path></svg>';
            const iconSheet = '<svg class="inline-icon muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="4" width="18" height="16" rx="2"></rect><path stroke-linecap="round" stroke-linejoin="round" d="M8 4v16"></path><path stroke-linecap="round" stroke-linejoin="round" d="M16 4v16"></path><path stroke-linecap="round" stroke-linejoin="round" d="M3 9h18"></path><path stroke-linecap="round" stroke-linejoin="round" d="M3 15h18"></path></svg>';
            const iconEye = '<svg class="inline-icon muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
            const iconAttachment = '<svg class="inline-icon muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M10 13a5 5 0 007.07 0l2.83-2.83a5 5 0 00-7.07-7.07L11 4"></path><path stroke-linecap="round" stroke-linejoin="round" d="M14 11a5 5 0 00-7.07 0L4.1 13.83a5 5 0 007.07 7.07L13 20"></path></svg>';
            const iconEmpty = '<svg class="inline-icon muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16a2 2 0 012 2v10a2 2 0 01-2 2H7l-3 3V6a2 2 0 012-2z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M8 9h8"></path><path stroke-linecap="round" stroke-linejoin="round" d="M8 13h5"></path></svg>';
            
            if (data.archivo_url) {
                let contenidoArchivo = '';
                
                // Usar archivo_tipo que viene del servidor
                if (data.archivo_tipo === 'pdf') {
                    contenidoArchivo = `
                        <div style="margin-bottom: 10px; font-size: 14px; color: #64748b;">
                            ${iconFile} ${data.archivo_nombre}
                        </div>
                        <embed 
                            src="${data.archivo_url}" 
                            type="application/pdf" 
                            width="100%" 
                            height="500px"
                            style="border-radius: 8px; border: 1px solid #e2e8f0;"
                        >
                        <div style="margin-top: 15px; text-align: center;">
                            <a href="${data.archivo_url}" target="_blank" class="download-btn">
                                ${iconDownload}Descargar PDF
                            </a>
                        </div>
                    `;
                } else if (data.archivo_tipo === 'imagen') {
                    contenidoArchivo = `
                        <div style="margin-bottom: 10px; font-size: 14px; color: #64748b;">
                            ${iconImage} ${data.archivo_nombre}
                        </div>
                        <img src="${data.archivo_url}" 
                             alt="Archivo adjunto" 
                             style="width: 100%; max-height: 500px; object-fit: contain; border-radius: 8px; border: 1px solid #e2e8f0;"
                             onerror="this.onerror=null; this.parentElement.innerHTML+='<div style=\'color:#ef4444;padding:20px;background:#fef2f2;border-radius:8px;\'>Error al cargar la imagen</div>'">
                        <div style="margin-top: 15px; text-align: center;">
                            <a href="${data.archivo_url}" target="_blank" class="download-btn">
                                ${iconDownload}Descargar imagen
                            </a>
                        </div>
                    `;
                } else if (data.archivo_tipo === 'word') {
                    contenidoArchivo = `
                        <div style="text-align: center; padding: 30px 20px;">
                            <div style="font-size: 0; margin-bottom: 20px; color: #2b579a;">${iconDoc}</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #1e293b;">
                                Documento de Word
                            </div>
                            <div style="font-size: 14px; color: #64748b; margin-bottom: 25px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                                ${data.archivo_nombre}
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <a href="https://docs.google.com/viewer?url=${encodeURIComponent(window.location.origin + data.archivo_url)}&embedded=true" 
                                   target="_blank" 
                                   class="download-btn" 
                                   style="background: #4285f4;">
                                    ${iconEye}Ver en Google Docs
                                </a>
                                <a href="${data.archivo_url}" target="_blank" class="download-btn">
                                    ${iconDownload}Descargar
                                </a>
                            </div>
                        </div>
                    `;
                } else if (data.archivo_tipo === 'excel') {
                    contenidoArchivo = `
                        <div style="text-align: center; padding: 30px 20px;">
                            <div style="font-size: 0; margin-bottom: 20px; color: #217346;">${iconSheet}</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #1e293b;">
                                Hoja de Calculo Excel
                            </div>
                            <div style="font-size: 14px; color: #64748b; margin-bottom: 25px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                                ${data.archivo_nombre}
                            </div>
                            <a href="${data.archivo_url}" target="_blank" class="download-btn">
                                ${iconDownload}Descargar archivo
                            </a>
                        </div>
                    `;
                } else {
                    contenidoArchivo = `
                        <div class="no-archivo">
                            <div class="no-archivo-icon">${iconAttachment}</div>
                            <div style="font-size:16px;margin-bottom:10px;">Archivo adjunto</div>
                            <div style="font-size:14px;color:#64748b;margin-bottom:15px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                                ${data.archivo_nombre}
                            </div>
                            <div style="font-size:12px;color:#94a3b8;margin-bottom:20px;padding: 8px 12px; background: #f1f5f9; border-radius: 6px;">
                                Tipo: ${data.archivo_tipo ? data.archivo_tipo.toUpperCase() : 'DESCONOCIDO'}
                            </div>
                            <a href="${data.archivo_url}" target="_blank" class="download-btn">
                                ${iconDownload}Descargar archivo
                            </a>
                        </div>
                    `;
                }
                
                archivoViewer.innerHTML = contenidoArchivo;
            } else {
                archivoViewer.innerHTML = `
                    <div class="no-archivo">
                        <div class="no-archivo-icon">${iconEmpty}</div>
                        <div style="font-size:16px;">No hay archivo adjunto</div>
                    </div>
                `;
            }

            // Mostrar modal
            document.getElementById('modalReporte').style.display = 'block';
            
            // Si es PDF, ajustar el height dinámicamente
            if (data.archivo_tipo === 'pdf') {
                setTimeout(() => {
                    const embed = archivoViewer.querySelector('embed');
                    if (embed) {
                        embed.style.height = '500px';
                    }
                }, 100);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los detalles del reporte');
        });
    }


    function cerrarModal() {
        document.getElementById('modalReporte').style.display = 'none';
    }

    window.onclick = function(event) {
        const modal = document.getElementById('modalReporte');
        if (event.target === modal) {
            cerrarModal();
        }
    }

    function enviarReporte(id) {
        if (confirm('Desea marcar este reporte como enviado?')) {
            const formData = new FormData();
            formData.append('estado', 'enviado');
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch(`/reportes/cambiar-estado/${id}/`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Reporte marcado como enviado exitosamente');
                    location.reload();
                } else {
                    alert('Error al actualizar el estado del reporte');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al procesar la solicitud');
            });
        }
    }

    function confirmarEliminar(id) {
        if (confirm('Esta seguro de que desea eliminar este reporte? Esta accion no se puede deshacer.')) {
            window.location.href = `/reportes/eliminar/${id}/`;
        }
    }

    document.getElementById('searchInput').addEventListener('keyup', function() {
        const searchValue = this.value.toLowerCase();
        const table = document.getElementById('reportesTable');
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const text = row.textContent.toLowerCase();
            
            if (text.includes(searchValue)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            cerrarModal();
        }
    });


    // Variables para PDF.js
    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    let scale = 1.0;

    function renderPage(num) {
        if (!pdfDoc) return;
        
        pageRendering = true;
        
        pdfDoc.getPage(num).then(function(page) {
            const canvas = document.getElementById('pdf-canvas');
            const ctx = canvas.getContext('2d');
            const viewport = page.getViewport({ scale: scale });
            
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            
            const renderTask = page.render(renderContext);
            
            renderTask.promise.then(function() {
                pageRendering = false;
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
            });
            
            document.getElementById('page-num').textContent = num;
        });
    }

    function loadPdf(url) {
        pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
            pdfDoc = pdfDoc_;
            document.getElementById('page-count').textContent = pdfDoc.numPages;
            document.getElementById('pdf-controls').style.display = 'block';
            renderPage(pageNum);
        });
    }

    function prevPage() {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    }

    function nextPage() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    }

    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    {% if ultimo_reporte and ultimo_reporte.archivo_documento and ultimo_reporte.archivo_documento.url|slice:"-4:"|lower == ".pdf" %}
        document.addEventListener('DOMContentLoaded', function() {
            loadPdf('{{ ultimo_reporte.archivo_documento.url }}');
        });
    {% endif %}
</script>

{% endblock %}
