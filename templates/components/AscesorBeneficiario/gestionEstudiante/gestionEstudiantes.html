{% extends "master/sideBar/base.html" %}

{% block title %}Gesti√≥n de Estudiantes{% endblock %}

{% block content %}

<style>
/* Fondo degradado general */
body {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    font-family: 'Poppins', sans-serif;
}

/* Contenedor principal */
.flex {
    display: flex;
}
.justify-between {
    justify-content: space-between;
}
.items-center {
    align-items: center;
}
.mb-6 {
    margin-bottom: 1.5rem;
}

/* T√≠tulo */
h1.text-2xl {
    font-size: 2rem;
    font-weight: 700;
    color: #fff;
    text-shadow: 1px 1px 5px rgba(0,0,0,0.3);
}

/* Bot√≥n Nuevo Estudiante */
a.px-5 {
    padding: 10px 20px;
    font-weight: 600;
    border-radius: 12px;
    background: linear-gradient(90deg, #12c2e9 0%, #c471ed 50%, #f64f59 100%);
    color: white;
    transition: transform 0.2s, box-shadow 0.2s;
    text-decoration: none;
}
a.px-5:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

/* Buscador */
#searchInput {
    width: 100%;
    max-width: 400px;
    padding: 10px 15px;
    border-radius: 12px;
    border: none;
    outline: none;
    font-size: 0.95rem;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

/* Tabla */
.bg-white {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    overflow-x: auto;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}
table {
    width: 100%;
    border-collapse: collapse;
    min-width: 900px;
}
thead {
    background: linear-gradient(90deg, #12c2e9 0%, #c471ed 50%, #f64f59 100%);
    color: white;
}
thead th {
    padding: 12px 15px;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
}
tbody td {
    padding: 12px 15px;
    font-size: 0.9rem;
    color: #333;
}
tbody tr {
    transition: background 0.2s, transform 0.2s;
}
tbody tr:hover {
    background: rgba(196,196,196,0.2);
    transform: scale(1.01);
}

/* Select estado y fecha defunci√≥n */
.estado-selector,
.fecha-defuncion {
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 0.85rem;
    transition: all 0.2s;
}
.estado-selector:hover,
.fecha-defuncion:hover {
    border-color: #2575fc;
    box-shadow: 0 2px 8px rgba(37,117,252,0.3);
}

/* Tiempo transcurrido y p√≥liza */
.tiempo-transcurrido {
    text-align: center;
    font-weight: 500;
}
</style>

<!-- HEADER -->
<div class="flex justify-between items-center mb-6 ">
    <h1 class="text-2xl font-bold text-gray-800">
        Gesti√≥n de Estudiantes
    </h1>

    <a href="{% url 'panel_asesor:registrar_estudiante' %}" class="px-5 py-2">
        + Nuevo Estudiante
    </a>
</div>

<!-- BUSCADOR -->
<div class="mb-6">
    <input
        type="text"
        id="searchInput"
        placeholder="Buscar por c√©dula, nombre o apellido"
    />
</div>

<!-- TABLA -->
<div class="bg-white rounded-xl shadow overflow-x-auto">
    <table class="min-w-full text-sm text-left">
        <thead>
            <tr>
                <th class="px-6 py-3">C√©dula</th>
                <th class="px-6 py-3">Nombres</th>
                <th class="px-6 py-3">Apellidos</th>
                <th class="px-6 py-3">Carrera</th>
                <th class="px-6 py-3">Nivel</th>
                <th class="px-6 py-3">Modalidad</th>
                <th class="px-6 py-3">Periodo</th>
                <th class="px-6 py-3">Estado</th>
                <th class="px-6 py-3">Fecha Defunci√≥n</th> 
                <th class="px-6 py-3">Tiempo transcurrido</th> 
                <th class="px-6 py-3">P√≥liza</th>
            </tr>
        </thead>

        <tbody id="tabla-estudiantes" class="divide-y">
            {% for estudiante in estudiantes %}
            <tr class="hover:bg-gray-50" data-id="{{ estudiante.id }}">
                <td class="px-6 py-3">{{ estudiante.cedula }}</td>
                <td class="px-6 py-3">{{ estudiante.nombres }}</td>
                <td class="px-6 py-3">{{ estudiante.apellidos }}</td>
                <td class="px-6 py-3">{{ estudiante.carrera }}</td>
                <td class="px-6 py-3">{{ estudiante.get_nivel_display }}</td>
                <td class="px-6 py-3">{{ estudiante.get_modalidad_display }}</td>
                <td class="px-6 py-3">{{ estudiante.periodo_academico }}</td>
                
                <!-- Selector de Estado -->
                <td class="px-6 py-3">
                    <select class="estado-selector" onchange="cambiarEstado(this)">
                        <option value="activo" {% if estudiante.estado == 'activo' %}selected{% endif %}>Activo</option>
                        <option value="inactivo" {% if estudiante.estado == 'inactivo' %}selected{% endif %}>Inactivo</option>
                        <option value="fallecido" {% if estudiante.estado == 'fallecido' %}selected{% endif %}>Fallecido</option>
                    </select>

                </td>

                <!-- Fecha defunci√≥n editable -->
                <td class="px-6 py-3">
                    <input
                        type="date"
                        class="fecha-defuncion"
                        value="{{ estudiante.fecha_defuncion|date:'Y-m-d' }}"
                        {% if estudiante.estado != 'fallecido' %}
                            style="display:none"
                        {% endif %}
                        onchange="guardarFechaDefuncion(this)"
                    >
                </td>


                <!-- Tiempo transcurrido -->
                <td class="px-6 py-3 tiempo-transcurrido">
                    {{ estudiante.tiempo_transcurrido|default:"-" }}
                </td>


                <td class="px-6 py-3">
                    {% if estudiante.poliza %}
                        {{ estudiante.poliza.get_estado_display }}
                    {% else %}
                        <span class="text-gray-400 text-xs">Sin p√≥liza</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- JS AJAX -->
<script>
const input = document.getElementById('searchInput');
const tbody = document.getElementById('tabla-estudiantes');

let timeout = null;

input.addEventListener('input', () => {
    clearTimeout(timeout);

    timeout = setTimeout(() => {
        fetch("{% url 'panel_asesor:buscar_estudiantes' %}?q=" + input.value)
            .then(response => response.json())
            .then(data => {
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="11" class="px-6 py-6 text-center text-gray-500">
                                No hay resultados
                            </td>
                        </tr>`;
                    return;
                }

                data.forEach(e => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-3">${e.cedula}</td>
                            <td class="px-6 py-3">${e.nombres}</td>
                            <td class="px-6 py-3">${e.apellidos}</td>
                            <td class="px-6 py-3">${e.carrera}</td>
                            <td class="px-6 py-3">${e.nivel}</td>
                            <td class="px-6 py-3">${e.modalidad}</td>
                            <td class="px-6 py-3">${e.periodo}</td>
                            <td class="px-6 py-3">${e.estado}</td>
                            <td class="px-6 py-3">${e.fecha_defuncion}</td>
                            <td class="px-6 py-3">${e.tiempo_transcurrido}</td>
                            <td class="px-6 py-3">${e.poliza}</td>
                        </tr>
                    `;
                });
            });
    }, 300);
});
function cambiarEstado(select) {
    const fila = select.closest('tr');
    const estudianteId = fila.dataset.id;
    const nuevoEstado = select.value;
    const inputFecha = fila.querySelector('.fecha-defuncion');
    const celdaTiempo = fila.querySelector('.tiempo-transcurrido');

    // üî• SI ES FALLECIDO
    if (nuevoEstado === 'fallecido') {
        inputFecha.style.display = 'inline-block';
        inputFecha.required = true;
        return; // NO guardamos a√∫n
    }

    // üî• SI CAMBIA A ACTIVO O INACTIVO ‚Üí LIMPIAR TODO
    inputFecha.style.display = 'none';
    inputFecha.required = false;
    inputFecha.value = '';

    // üßπ LIMPIAR TIEMPO TRANSCURRIDO EN LA TABLA
    celdaTiempo.textContent = '-';

    // üîÅ Guardar cambio en backend
    fetch("{% url 'panel_asesor:cambiar_estado_estudiante' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: `id=${estudianteId}&estado=${nuevoEstado}`
    });
}


function guardarFechaDefuncion(input) {
    const fila = input.closest('tr');
    const estudianteId = fila.dataset.id;
    const celdaTiempo = fila.querySelector('.tiempo-transcurrido');

    if (!input.value) {
        alert("La fecha de defunci√≥n es obligatoria");
        return;
    }

    // üî• CALCULAR Y MOSTRAR EN VIVO
    const tiempo = calcularTiempoTranscurrido(input.value);
    celdaTiempo.textContent = tiempo;

    // üîÅ AHORA S√ç, guardar en backend
    fetch("{% url 'panel_asesor:cambiar_estado_estudiante' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: `id=${estudianteId}&estado=fallecido&fecha_defuncion=${input.value}`
    });
}function calcularTiempoTranscurrido(fechaDefuncion) {
    const [year, month, day] = fechaDefuncion.split('-').map(Number);

    // üîí Fecha SIN zona horaria
    const fecha = new Date(year, month - 1, day);
    const hoy = new Date();

    let years = hoy.getFullYear() - fecha.getFullYear();
    let months = hoy.getMonth() - fecha.getMonth();
    let days = hoy.getDate() - fecha.getDate();

    if (days < 0) {
        months--;
        const ultimoMes = new Date(hoy.getFullYear(), hoy.getMonth(), 0).getDate();
        days += ultimoMes;
    }

    if (months < 0) {
        years--;
        months += 12;
    }

    if (years > 0) {
        return `${years} a√±os ${months} meses ${days} d√≠as`;
    }

    return `${months} meses ${days} d√≠as`;
}

</script>

{% endblock %}
