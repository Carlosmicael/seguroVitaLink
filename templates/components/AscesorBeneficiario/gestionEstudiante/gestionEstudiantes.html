{% extends "master/sideBar/base.html" %}

{% block title %}Gesti√≥n de Estudiantes{% endblock %}

{% block content %}

<style>
/* Fondo general */
body {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    font-family: 'Poppins', sans-serif;
    margin: 0;
}

/* Card principal */
.page-card {
    max-width: 95%;
    height: 90vh;
    margin: 40px auto;
    padding: 30px;
}

/* Flex helpers */
.flex {
    display: flex;
}
.justify-between {
    justify-content: space-between;
}
.items-center {
    align-items: center;
}
.mb-6 {
    margin-bottom: 1.5rem;
}

/* T√≠tulo */
h1.text-2xl {
    font-size: 2.4rem;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    position: relative;
    line-height: 1.2;
}



/* Bot√≥n */
a.px-5 {
    padding: 12px 22px;
    font-weight: 600;
    border-radius: 14px;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    text-decoration: none;
    transition: all 0.25s ease;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
}
a.px-5:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.35);
}

.btn-importar {
    padding: 12px 22px;
    font-weight: 600;
    border-radius: 14px;
    color: white;
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    border: none;
    cursor: pointer;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    transition: all 0.3s ease;
}

.btn-importar:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.35);
}



/* Contenedor del buscador */
.search-box {
    display: flex;
    align-items: center;
    max-width: 520px;
    background: white;
    border-radius: 16px;
    padding: 6px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    transition: box-shadow 0.25s ease;
}

.search-box:focus-within {
    box-shadow: 0 10px 28px rgba(106,17,203,0.35);
}

/* Input buscador */
.search-box input {
    flex: 1;
    border: none;
    outline: none;
    padding: 12px 16px;
    font-size: 0.95rem;
    border-radius: 12px;
    color: #333;
}

/* Bot√≥n buscar */
.search-btn {
    padding: 12px 18px;
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: white;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.25s ease;
    box-shadow: 0 6px 16px rgba(0,0,0,0.25);
}

.search-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 22px rgba(0,0,0,0.35);
}

.search-btn i {
    font-size: 0.9rem;
}

/* Tabla */
.bg-white {
    overflow-x: auto;
    box-shadow: 0 12px 30px rgba(0,0,0,0.12);
}

table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1400px; /* ajusta seg√∫n tus columnas */
}


thead {
    background: linear-gradient(90deg, #6a11cb, #2575fc);
    color: white;
}

thead th {
    padding: 14px;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.6px;
}

tbody td {
    padding: 14px;
    font-size: 0.9rem;
    color: #333;
}

tbody tr {
    transition: all 0.25s ease;
}
tbody tr:hover {
    background: rgba(106,17,203,0.06);
    transform: scale(1.005);
}

/* Select y date */
.estado-selector,
.fecha-defuncion {
    padding: 7px 12px;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 0.85rem;
}
.estado-selector:focus,
.fecha-defuncion:focus {
    outline: none;
    border-color: #6a11cb;
    box-shadow: 0 0 0 2px rgba(106,17,203,0.2);
}

/* Texto centrado */
.tiempo-transcurrido {
    text-align: center;
    font-weight: 600;
}
td.text-center a,
td.text-center button {
    white-space: nowrap;
}

</style>

<div class="page-card">
<!-- HEADER -->
<div class="flex justify-between items-center mb-6 ">
    <h1 class="text-2xl font-bold text-gray-800">
        Gesti√≥n de Estudiantes
    </h1>
        <!-- FORMULARIO IMPORTAR EXCEL -->
    <div class="mb-6">
        <form method="post" enctype="multipart/form-data" id="form-importar">
            {% csrf_token %}
            <!-- input oculto -->
            <input type="file" name="archivo" accept=".xlsx,.csv" required
                id="input-archivo" style="display:none;">
           <!-- bot√≥n visible -->
            <button type="button" 
                    class="btn-importar"
                    onclick="document.getElementById('input-archivo').click();">
                üì• Seleccionar Archivo
            </button>

             <a href="{% url 'panel_asesor:registrar_estudiante' %}" class="px-5 py-2">
                + Nuevo Estudiante
            </a>
        </form>
    </div>


   
</div>


<!-- BUSCADOR -->
<div class="mb-6">
    <div class="search-box">
        <input
            type="text"
            id="searchInput"
            placeholder="Buscar por c√©dula, nombre o apellido"
        >
        <button class="search-btn" type="button" id="searchBtn">
            <i class="fas fa-search"></i>
            Buscar
        </button>
    </div>
</div>


<!-- TABLA -->
<div class="bg-white rounded-xl shadow overflow-x-auto">
    <table class="min-w-full text-sm text-left">
        <thead>
            <tr>
                <th class="px-6 py-3">C√©dula</th>
                <th class="px-6 py-3">Nombres</th>
                <th class="px-6 py-3">Apellidos</th>
                <th class="px-6 py-3">Carrera</th>
                <th class="px-6 py-3">Nivel</th>
                <th class="px-6 py-3">Modalidad</th>
                <th class="px-6 py-3">Periodo</th>
                <th class="px-6 py-3">Estado</th>
                <th class="px-6 py-3">Fecha Defunci√≥n</th> 
                <th class="px-6 py-3">Tiempo transcurrido</th> 
                <th class="px-6 py-3">P√≥liza</th>
                <th class="px-6 py-3 text-center">Editar</th>
                <th class="px-6 py-3 text-center">Eliminar</th>


            </tr>
        </thead>

        <tbody id="tabla-estudiantes" class="divide-y">
            {% for estudiante in estudiantes %}
            <tr class="hover:bg-gray-50" data-id="{{ estudiante.id }}">
                <td class="px-6 py-3">{{ estudiante.cedula }}</td>
                <td class="px-6 py-3">{{ estudiante.nombres }}</td>
                <td class="px-6 py-3">{{ estudiante.apellidos }}</td>
                <td class="px-6 py-3">{{ estudiante.carrera }}</td>
                <td class="px-6 py-3">{{ estudiante.get_nivel_display }}</td>
                <td class="px-6 py-3">{{ estudiante.get_modalidad_display }}</td>
                <td class="px-6 py-3">{{ estudiante.periodo_academico }}</td>
                
                <!-- Selector de Estado -->
                <td class="px-6 py-3">
                    <select class="estado-selector" onchange="cambiarEstado(this)">
                        <option value="activo" {% if estudiante.estado == 'activo' %}selected{% endif %}>Activo</option>
                        <option value="inactivo" {% if estudiante.estado == 'inactivo' %}selected{% endif %}>Inactivo</option>
                        <option value="fallecido" {% if estudiante.estado == 'fallecido' %}selected{% endif %}>Fallecido</option>
                    </select>

                </td>

                <!-- Fecha defunci√≥n editable -->
                <td class="px-6 py-3">
                    <input
                        type="date"
                        class="fecha-defuncion"
                        value="{{ estudiante.fecha_defuncion|date:'Y-m-d' }}"
                        {% if estudiante.estado != 'fallecido' %}
                            style="display:none"
                        {% endif %}
                        onchange="guardarFechaDefuncion(this)"
                    >
                </td>


                <!-- Tiempo transcurrido -->
                <td class="px-6 py-3 tiempo-transcurrido">
                    {{ estudiante.tiempo_transcurrido|default:"-" }}
                </td>


                <td class="px-6 py-3">
                    {% if estudiante.poliza %}
                        {{ estudiante.poliza.get_estado_display }}
                    {% else %}
                        <span class="text-gray-400 text-xs">Sin p√≥liza</span>
                    {% endif %}
                </td>
                <td class="px-6 py-3 text-center">
                    <a href="{% url 'panel_asesor:editar_estudiante' estudiante.id %}"
                    class="px-4 py-2 rounded-lg text-white font-semibold"
                    style="background: linear-gradient(135deg, #ff9800, #ff5722); text-decoration:none;">
                        ‚úèÔ∏è Editar
                    </a>
                </td>
                <td class="px-6 py-3 text-center">
                    <button onclick="eliminarEstudiante(this)" 
                            class="px-4 py-2 rounded-lg text-white font-semibold"
                            style="background: linear-gradient(135deg, #e53935, #b71c1c); border:none; cursor:pointer;">
                        üóëÔ∏è Eliminar
                    </button>
                </td>




            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
</div>

<!-- JS AJAX -->
<script>

const input = document.getElementById('searchInput');
const tbody = document.getElementById('tabla-estudiantes');
const searchBtn = document.getElementById('searchBtn');
let cambiosPendientes = false;

let timeout = null;

/* üîç FUNCI√ìN √öNICA DE B√öSQUEDA */
function buscarEstudiantes() {
    fetch("{% url 'panel_asesor:buscar_estudiantes' %}?q=" + input.value)
        .then(response => response.json())
        .then(data => {
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="px-6 py-6 text-center text-gray-500">
                            No hay resultados
                        </td>
                    </tr>`;
                return;
            }

            data.forEach(e => {
    tbody.innerHTML += `
        <tr class="hover:bg-gray-50" data-id="${e.id}">
            <td class="px-6 py-3">${e.cedula}</td>
            <td class="px-6 py-3">${e.nombres}</td>
            <td class="px-6 py-3">${e.apellidos}</td>
            <td class="px-6 py-3">${e.carrera}</td>
            <td class="px-6 py-3">${e.nivel}</td>
            <td class="px-6 py-3">${e.modalidad}</td>
            <td class="px-6 py-3">${e.periodo}</td>

            <!-- SELECT ESTADO -->
            <td class="px-6 py-3">
                <select class="estado-selector" onchange="cambiarEstado(this)">
                    <option value="activo" ${e.estado === 'activo' ? 'selected' : ''}>Activo</option>
                    <option value="inactivo" ${e.estado === 'inactivo' ? 'selected' : ''}>Inactivo</option>
                    <option value="fallecido" ${e.estado === 'fallecido' ? 'selected' : ''}>Fallecido</option>
                </select>
            </td>

            <!-- FECHA DEFUNCI√ìN -->
            <td class="px-6 py-3">
                <input
                    type="date"
                    class="fecha-defuncion"
                    value="${e.fecha_defuncion || ''}"
                    style="${e.estado === 'fallecido' ? '' : 'display:none'}"
                    onchange="guardarFechaDefuncion(this)"
                >
            </td>

            <!-- TIEMPO -->
            <td class="px-6 py-3 tiempo-transcurrido">
                ${e.dias_transcurridos}
            </td>

            <!-- P√ìLIZA -->
            <td class="px-6 py-3">${e.poliza}</td>
            
            <!-- EDITAR -->
             <td class="px-6 py-3 text-center">
                <a href="/panel-asesor/estudiantes/editar/${e.id}/"
                class="px-4 py-2 rounded-lg text-white font-semibold"
                style="background: linear-gradient(135deg, #ff9800, #ff5722); text-decoration:none;">
                ‚úèÔ∏è Editar
                </a>
            </td>
             <td class="px-6 py-3 text-center">
                <button onclick="eliminarEstudiante(this)" 
                        class="px-4 py-2 rounded-lg text-white font-semibold"
                        style="background: linear-gradient(135deg, #e53935, #b71c1c); border:none; cursor:pointer; white-space: nowrap;">
                    üóëÔ∏è Eliminar
                </button>
            </td>
            </tr>
        `;
    });

        });
}

/* ‚úçÔ∏è BUSCAR AL ESCRIBIR (debounce) */
input.addEventListener('input', () => {
    clearTimeout(timeout);
    timeout = setTimeout(buscarEstudiantes, 300);
});

/* üñ±Ô∏è BUSCAR AL DAR CLICK */
searchBtn.addEventListener('click', buscarEstudiantes);

/* ‚å®Ô∏è BUSCAR CON ENTER */
input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        buscarEstudiantes();
    }
});


function cambiarEstado(select) {
    const fila = select.closest('tr');
    const estudianteId = fila.dataset.id;
    const nuevoEstado = select.value;
    const inputFecha = fila.querySelector('.fecha-defuncion');
    const celdaTiempo = fila.querySelector('.tiempo-transcurrido');

    // üî• SI ES FALLECIDO
    if (nuevoEstado === 'fallecido') {
        inputFecha.style.display = 'inline-block';
        inputFecha.required = true;
        return; // NO guardamos a√∫n
    }

    // üî• SI CAMBIA A ACTIVO O INACTIVO ‚Üí LIMPIAR TODO
    inputFecha.style.display = 'none';
    inputFecha.required = false;
    inputFecha.value = '';

    // üßπ LIMPIAR TIEMPO TRANSCURRIDO EN LA TABLA
    celdaTiempo.textContent = '-';

    // üîÅ Guardar cambio en backend
    fetch("{% url 'panel_asesor:cambiar_estado_estudiante' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrftoken

        },
        body: `id=${estudianteId}&estado=${nuevoEstado}`
    });
}


function guardarFechaDefuncion(input) {
    const fila = input.closest('tr');
    const estudianteId = fila.dataset.id;
    const celdaTiempo = fila.querySelector('.tiempo-transcurrido');

    if (!input.value) {
        alert("La fecha de defunci√≥n es obligatoria");
        return;
    }

    // üî• CALCULAR Y MOSTRAR EN VIVO
    const tiempo = calcularTiempoTranscurrido(input.value);
    celdaTiempo.textContent = tiempo;

    // üîÅ AHORA S√ç, guardar en backend
    fetch("{% url 'panel_asesor:cambiar_estado_estudiante' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrftoken
        },
        body: `id=${estudianteId}&estado=fallecido&fecha_defuncion=${input.value}`
    });
}function calcularTiempoTranscurrido(fechaDefuncion) {
    const [year, month, day] = fechaDefuncion.split('-').map(Number);

    // üîí Fecha SIN zona horaria
    const fecha = new Date(year, month - 1, day);
    const hoy = new Date();

    let years = hoy.getFullYear() - fecha.getFullYear();
    let months = hoy.getMonth() - fecha.getMonth();
    let days = hoy.getDate() - fecha.getDate();

    if (days < 0) {
        months--;
        const ultimoMes = new Date(hoy.getFullYear(), hoy.getMonth(), 0).getDate();
        days += ultimoMes;
    }

    if (months < 0) {
        years--;
        months += 12;
    }

    if (years > 0) {
        return `${years} a√±os ${months} meses ${days} d√≠as`;
    }

    return `${months} meses ${days} d√≠as`;
}
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');
function eliminarEstudiante(button) {
    if (!confirm("¬øEst√°s seguro de eliminar este estudiante?")) return;

    const fila = button.closest('tr');
    const estudianteId = fila.dataset.id;

    fetch("{% url 'panel_asesor:eliminar_estudiante' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrftoken
        },
        body: `id=${estudianteId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fila.remove(); // Remueve la fila de la tabla
        } else {
            alert("No se pudo eliminar el estudiante.");
        }
    });
}
    // Cuando se seleccione un archivo, enviar el formulario autom√°ticamente
    const inputArchivo = document.getElementById('input-archivo');
    const formImportar = document.getElementById('form-importar');

    inputArchivo.addEventListener('change', () => {
        if(inputArchivo.files.length > 0){
            formImportar.submit();
        }
    });
</script>

{% endblock %}
